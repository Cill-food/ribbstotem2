<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cozinha - Ribbs</title>
    <script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.5/qz-tray.min.js"></script>
    <style>
      /* CORES PROFISSIONAIS */
      :root {
        --preto: #1e1e1e; /* Quase preto */
        --branco: #ffffff;
        --cinza-claro: #f4f4f4;
        --cinza-escuro: #333333;
        --accent-verde: #00a651; /* Verde de sucesso/iFood */
        --accent-amarelo: #ffc72c; /* Amarelo de alerta */
        --accent-vermelho: #e74c3c; /* Vermelho de cancelamento */
        --sombra: 0 4px 12px rgba(0, 0, 0, 0.1);
        --sombra-card: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--cinza-claro);
        color: var(--cinza-escuro);
        margin: 0;
        padding: 0;
        transition: background-color 0.3s, color 0.3s; /* Transição suave */
      }
      /* CORES TEMA ESCURO */
      body.dark-mode {
        --preto: #f4f4f4; /* Invertido */
        --branco: #2c2c2c; /* Cor de fundo dos cards no tema escuro */
        --cinza-claro: #121212; /* Fundo principal escuro */
        --cinza-escuro: #cccccc; /* Texto claro */
        --sombra: 0 4px 12px rgba(255, 255, 255, 0.1);
        --sombra-card: 0 2px 8px rgba(255, 255, 255, 0.15);
        background-color: var(--cinza-claro);
        color: var(--cinza-escuro);
      }
      body.dark-mode h1 {
        color: var(--accent-verde);
        text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.1);
      }
      body.dark-mode .card {
        background-color: var(--branco);
        color: var(--cinza-escuro);
        box-shadow: var(--sombra-card);
      }
      body.dark-mode .card-header {
        border-bottom: 1px solid #444;
      }
      body.dark-mode .card-header h3 {
        color: var(--cinza-escuro);
      }
      body.dark-mode .card-content strong {
        color: var(--cinza-escuro);
      }
      body.dark-mode .card-content .itens {
        border-left: 3px solid #444;
      }
      body.dark-mode .modal-content {
        background-color: #1e1e1e; /* Fundo do modal escuro */
        color: var(--cinza-escuro);
      }
      body.dark-mode .modal-content .close-btn {
        color: var(--cinza-escuro);
      }
      body.dark-mode .cozinha-card {
        background-color: #383838;
        box-shadow: 0 1px 3px rgba(255, 255, 255, 0.05);
      }
      body.dark-mode .cozinha-card-info h4 {
        color: var(--preto);
      }
      body.dark-mode .cozinha-sessao-topo button {
        background: #444;
        color: var(--cinza-escuro);
      }
      body.dark-mode .cozinha-sessao-topo button.active {
        background-color: var(--accent-verde);
        color: white;
      }
      body.dark-mode h2 {
        color: var(--cinza-escuro);
      }
      body.dark-mode .btn-fechar {
        background-color: var(--cinza-escuro);
        color: var(--preto); /* Branco para o texto do botão no dark mode */
      }
      body.dark-mode .btn-salvar {
        background-color: var(--accent-verde);
        color: var(--preto);
      }
      /* FIM CORES TEMA ESCURO */

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      .painel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px; /* Separa cabeçalho do conteúdo */
      }
      h1 {
        /* text-align: center; REMOVIDO para alinhamento com botão */
        color: var(--accent-verde);
        /* margin-bottom: 30px; REMOVIDO, movido para .painel-header */
        font-size: 2.5em;
        font-weight: 700;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        margin: 0; /* Importante para flex layout */
      }
      h2 {
        text-align: left;
        color: var(--cinza-escuro);
        border-bottom: 2px solid var(--accent-amarelo);
        padding-bottom: 5px;
        margin-top: 30px;
        margin-bottom: 20px;
        font-size: 1.8em;
        transition: color 0.3s;
      }

      /* LAYOUT EM GRID */
      .pedidos-pendentes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .pedidos-concluidos-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* ESTILO DO CARD (PROFISSIONAL) */
      .card {
        background-color: var(--branco);
        color: var(--cinza-escuro);
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--sombra-card);
        transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--sombra);
      }

      /* NOVO ESTILO: Cards Concluídos/Cancelados e Minimização */
      .card.collapsed {
        padding: 10px 20px;
        opacity: 0.9;
        cursor: pointer;
      }
      .card.concluido {
        border-left: 5px solid var(--accent-verde);
      }
      .card.cancelado {
        border-left: 5px solid var(--accent-vermelho);
      }
      .card.collapsed .card-content,
      .card.collapsed .card-actions {
        display: none;
      }
      .card-header .toggle-icon {
        font-size: 1.5em;
        font-weight: bold;
        cursor: pointer;
        margin-left: 15px;
        color: var(--cinza-escuro);
        transition: transform 0.2s;
        line-height: 0.8;
      }
      .card.collapsed .card-header .toggle-icon {
        transform: rotate(
          90deg
        ); /* Aponta para o lado quando minimizado/fechado */
      }
      .card:not(.collapsed) .card-header .toggle-icon {
        transform: rotate(-90deg); /* Aponta para baixo quando expandido */
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        transition: border-bottom 0.3s;
      }
      .card-header h3 {
        margin: 0;
        color: var(--preto);
        font-size: 1.2em;
        font-weight: 600;
        flex-grow: 1; /* Permite que o título ocupe espaço */
        transition: color 0.3s;
      }

      /* ESTILOS DE BADGE DE STATUS E TIPO */
      .card-header span {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.85em;
        color: var(--branco);
        text-transform: uppercase;
      }

      /* Novo: Estilos para o badge de tipo */
      .tipo-badge {
        margin-right: 8px; /* Espaçamento entre o tipo e o status */
      }
      .tipo-mesa {
        background-color: #007bff; /* Azul para Mesa */
      }
      .tipo-autoatendimento {
        background-color: #fd7e14; /* Laranja para Autoatendimento */
      }

      /* Estilos para o badge de status */
      .card-header .status-pendente {
        background-color: var(--accent-amarelo);
      }
      .card-header .status-aceito {
        background-color: #17a2b8;
      }
      .card-header .status-concluido,
      .card-header .status-pronto {
        background-color: var(--accent-verde);
      }
      .card-header .status-cancelado {
        background-color: var(--accent-vermelho);
      }
      .card-content p,
      .card-content div {
        margin: 8px 0;
        font-size: 0.95em;
      }
      .card-content strong {
        color: var(--cinza-escuro);
        transition: color 0.3s;
      }
      .card-content .itens {
        padding-left: 15px;
        border-left: 3px solid var(--cinza-claro);
        white-space: pre-wrap; /* Mantém quebras de linha (br) */
        transition: border-left 0.3s;
      }
      .card-content .pagamento-troco {
        color: var(--accent-vermelho);
        font-weight: bold;
      }
      .card-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #eee;
      }
      .card-actions button {
        flex-grow: 1;
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: background 0.2s, transform 0.1s;
        touch-action: manipulation;
        min-width: 100px;
      }

      /* ESTILOS DE BOTÕES DE AÇÃO */
      .btn-aceitar {
        background-color: #28a745;
        color: var(--branco);
      }
      .btn-pronto {
        background-color: var(--accent-verde);
        color: var(--branco);
      }
      .btn-adicionar {
        background-color: var(--accent-amarelo);
        color: var(--preto);
      }
      .btn-cancelar,
      .btn-excluir {
        background-color: var(--accent-vermelho);
        color: var(--branco);
      }
      
      /* NOVO ESTILO: Botão Imprimir */
      .btn-imprimir {
          background-color: #5bc0de; /* Azul/Ciano, cor de informação */
          color: var(--branco);
      }
      .body.dark-mode .btn-imprimir {
          background-color: #3e98b0; 
      }
      
      /* Hover effects */
      .card-actions button:hover {
        opacity: 0.9;
        transform: scale(0.98);
      }

      /* ESTILOS DO MODAL */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 1000;
        display: none;
      }
      .modal-content {
        background-color: var(--branco);
        color: var(--cinza-escuro);
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        box-shadow: var(--sombra);
        max-height: 90vh;
        overflow-y: auto;
        position: relative; /* ADICIONADO PARA POSICIONAR O BOTÃO FECHAR */
        transition: background-color 0.3s, color 0.3s;
      }

      /* NOVO ESTILO: Botão de Fechar do Modal (X) */
      .modal-content .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.8em; /* Um pouco maior para visibilidade */
        font-weight: 300; /* Mais fino, estilo moderno de "X" */
        color: var(--cinza-escuro);
        cursor: pointer;
        transition: color 0.2s;
        padding: 0;
        line-height: 1;
        opacity: 0.7;
      }
      .modal-content .close-btn:hover {
        color: var(--accent-vermelho);
        opacity: 1;
      }

      .modal-content h3 {
        margin-top: 0;
        color: var(--accent-verde);
        border-bottom: 2px solid var(--accent-amarelo);
        padding-bottom: 10px;
      }
      .modal-content input {
        width: 100%;
        padding: 12px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
      }
      .btn-modal {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin: 0 5px;
      }
      .btn-salvar {
        background-color: var(--accent-verde);
        color: var(--branco);
      }
      .btn-fechar {
        background-color: var(--cinza-escuro);
        color: var(--branco);
      }

      /* Modal de Remoção de Item (Apenas estilização, sem funcionalidade aqui) */
      #modal-remover-item .modal-content {
        max-width: 500px;
      }
      .item-remocao-list {
        max-height: 40vh;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 15px;
      }
      .item-remocao {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px dotted #ccc;
        font-size: 0.95em;
      }
      .item-remocao:last-child {
        border-bottom: none;
      }
      .btn-remover-item {
        background-color: var(--accent-vermelho);
        color: var(--branco);
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
        line-height: 1;
        font-size: 1em;
        flex-shrink: 0;
      }

      /* CARDÁPIO NO MODAL */
      .cozinha-sessao-topo {
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        margin-bottom: 15px;
        overflow-x: auto;
        padding-bottom: 10px;
      }
      .cozinha-sessao-topo button {
        background: #eee;
        color: var(--cinza-escuro);
        border-radius: 6px;
        border: none;
        padding: 8px 15px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.9em;
        min-width: 100px;
        transition: background 0.2s;
      }
      .cozinha-sessao-topo button.active {
        background-color: var(--accent-verde);
        color: white;
      }
      .cozinha-cardapio-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 5px;
      }
      .cozinha-card {
        background-color: var(--cinza-claro);
        border-radius: 8px;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: background-color 0.3s;
      }
      .cozinha-card-info h4 {
        margin: 0 0 5px 0;
        color: var(--preto);
        transition: color 0.3s;
      }
      .cozinha-card-info p {
        margin: 0;
        font-size: 0.85em;
        color: var(--cinza-escuro);
      }
      .cozinha-card-info p.price {
        font-weight: bold;
        color: var(--accent-vermelho);
        margin-top: 5px;
      }
      .cozinha-card button {
        background-color: var(--accent-amarelo);
        color: var(--preto);
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      /* NOTIFICAÇÃO (TOAST) */
      .custom-notification {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--accent-verde);
        color: white;
        padding: 15px 30px;
        border-radius: 8px;
        box-shadow: var(--sombra);
        z-index: 1500;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        font-weight: bold;
        text-align: center;
        min-width: 300px;
      }
      .custom-notification.show {
        opacity: 1;
      }

      /* NOVO: ESTILOS DE IMPRESSÃO (Recibo/Cupom) */
      @media print {
          /* Esconde tudo que não for o conteúdo de impressão */
          body * {
              visibility: hidden;
          }
          /* Torna visível o container de impressão e seus filhos */
          #print-output-container, #print-output-container * {
              visibility: visible;
              background-color: white !important; /* Fundo branco para economia */
              color: black !important; /* Texto preto */
              box-shadow: none !important;
              text-shadow: none !important;
              font-family: monospace, sans-serif !important; /* Fonte monoespaçada para estilo de recibo */
          }
          #print-output-container {
              position: absolute;
              left: 0;
              top: 0;
              width: 100%;
              max-width: 80mm; /* Largura padrão de impressora térmica */
              margin: 0 auto;
              padding: 5px;
              box-sizing: border-box;
              font-size: 10pt; /* Tamanho de fonte padrão */
          }
          .print-header h1 {
              font-size: 1.2em;
              text-align: center;
              margin-bottom: 5px;
              font-weight: bold;
              color: black !important;
          }
          .print-separator {
              border-top: 1px dashed black;
              margin: 5px 0;
          }
          .print-info p, .print-payment p {
              margin: 2px 0;
          }
          .print-items {
              margin-top: 10px;
          }
          .print-item {
              display: flex;
              justify-content: space-between;
              margin-bottom: 3px;
              line-height: 1.2;
          }
          .print-item .quantity {
              font-weight: bold;
              flex-shrink: 0;
              width: 15%;
              text-align: right;
              padding-right: 5px;
          }
          .print-item span:nth-child(2) {
              flex-grow: 1;
              margin-left: 5px;
          }
          .print-total {
              font-size: 1.1em;
              font-weight: bold;
              margin-top: 5px;
              text-align: right;
          }
      }
      /* Forçar impressão térmica 58mm SEM A4 */
@page {
    size: 58mm auto; /* Largura fixa da impressora, altura automática */
    margin: 0;       /* Remove margens que o navegador cria */
}

/* Garantir que somente o recibo seja impresso */
@media print {
    body {
        margin: 0;
        padding: 0;
    }

    #print-output-container {
        width: 58mm !important;
        max-width: 58mm !important;
        padding: 0;
        margin: 0 auto;
        box-shadow: none !important;
        background: #fff !important;
        font-size: 10pt !important;
    }

    body * {
        visibility: hidden;
    }

    #print-output-container, #print-output-container * {
        visibility: visible;
    }
}


    </style>
  </head>
  <body>
    <div class="container">
      <div class="painel-header">
        <h1>Painel de Pedidos - Ribbs</h1>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button
            id="novo-pedido"
            style="
              background-color: #e74c3c;
              color: #fff;
              border: none;
              border-radius: 8px;
              padding: 8px 15px;
              font-size: 0.9em;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              transition: background 0.2s;
            "
            onclick="adicionarNovoPedido()"
          >
            Novo Pedido
          </button>
          <button
            id="theme-toggle"
            class="btn-fechar"
            style="
              padding: 8px 15px;
              font-size: 0.9em;
              min-width: auto;
              flex-shrink: 0;
            "
          >
            Modo Escuro
          </button>
        </div>
        </div>
      <div class="pedidos-pendentes">
        <h2>Pedidos Pendentes (Cozinha e Garçom)</h2>
        <div id="pendentes" class="pedidos-pendentes-grid"></div>
      </div>
      <div class="pedidos-concluidos">
        <h2>Concluídos / Cancelados (Histórico)</h2>
        <div id="concluidos" class="pedidos-concluidos-list"></div>
      </div>
    </div>

    <div id="modal-adicionar" class="modal">
      <div class="modal-content">
        <h3>Adicionar Observação À Comanda</h3>
        <input
          type="text"
          id="ingredientes-input"
          placeholder="Digite a observação ou ingredientes adicionais..."
        />
        <button class="btn-modal btn-salvar" onclick="salvarIngredientes()">
          Salvar
        </button>
        <button
          class="btn-modal btn-fechar"
          onclick="fecharModal('modal-adicionar')"
        >
          Fechar
        </button>
      </div>
    </div>
    
    <div id="modal-novo-pedido-nome" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <button class="close-btn" onclick="fecharModal('modal-novo-pedido-nome')">×</button>
            <h3 style="color: var(--accent-verde)">Novo Pedido / Comanda</h3>
            <input
            type="text"
            id="nome-comanda-input"
            placeholder="Digite o nome da comanda ou cliente..."
            />
            <button class="btn-modal btn-salvar" onclick="confirmarNovoPedido()">
            Criar Comanda e Adicionar Item
            </button>
            <button
            class="btn-modal btn-fechar"
            onclick="fecharModal('modal-novo-pedido-nome')"
            >
            Cancelar
            </button>
        </div>
    </div>
    <div id="modal-adicionar-item" class="modal">
      <div class="modal-content">
        <h3 style="color: var(--cinza-escuro)">Adicionar Item À Comanda</h3>
        <div class="cozinha-sessao-topo" id="cozinha-sessao-topo"></div>
        <div class="cozinha-cardapio-container" id="cozinha-cardapio"></div>
        <button
          class="btn-modal btn-fechar"
          style="margin-top: 20px"
          onclick="fecharModal('modal-adicionar-item')"
        >
          Concluir Adições
        </button>
      </div>
    </div>

    <div id="modal-remover-item" class="modal">
      <div class="modal-content">
        <h3 style="color: var(--accent-vermelho)">Remover Item da Comanda</h3>
        <p>Comanda: <strong id="remocao-mesa-id"></strong></p>
        <div class="item-remocao-list" id="itens-para-remocao"></div>
        <p>
          <strong
            >Total Estimado Atual: R$
            <span id="remocao-novo-total">0.00</span></strong
          >
        </p>
        <button
          class="btn-modal btn-fechar"
          onclick="fecharModal('modal-remover-item')"
        >
          Concluir / Fechar
        </button>
      </div>
    </div>

    <div id="popupCustom" class="modal" aria-hidden="true">
      <div class="modal-content">
        <button class="close-btn" onclick="closePopupCustom()">×</button>
        <h3 id="popupCustomTitle">Personalize seu item</h3>
        <div id="popupQuestion" style="text-align: left"></div>
        <div id="popupResumo"></div>
        <div style="text-align: center; margin-top: 20px">
          <button
            class="btn-modal btn-salvar"
            id="confirmCustomBtn"
            onclick="confirmPopupCustom()"
          >
            Adicionar À Comanda
          </button>
          <button
            class="btn-modal btn-fechar"
            style="margin-left: 10px"
            onclick="closePopupCustom()"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
    
    <div id="print-output-container"></div>
    <div id="custom-notification" class="custom-notification">
      <p id="notification-message"></p>
    </div>

    <script>
      let pedidoSelecionadoId = null;
      let activeMesaId = null; // ID da mesa/comanda ativa para adição de item
      let currentItem = null; // Para popup de personalização

      let cardapioData = {
        Promoções: [
          {
            nome: "Batata G",
            descricao:
              "Batata G,Cheddar,Bacon, crocância e sabor inconfundível.",
            precoBase: [16],
            opcoes: ["Por apenas"],
            img: "./img/batatag.png",
            adicionais: [
              { nome: "Bacon separado", preco: 0 },
              { nome: "Cheddar separado", preco: 0 },
            ],
          },
          {
            nome: "1 Simples + 1 Duplo",
            descricao:
              "Acompanha um Smash Simples e um Smash Duplo deliciosos.",
            precoBase: [25],
            opcoes: ["Por apenas"],
            img: "./img/simplesduplo.png",
            combo: true,
            burgers: ["Simples", "Duplo"],
            simplesIngredients: [
              "Cebola caramelizada",
              "Molho artesanal",
              "Cheddar fatiado",
            ],
            duploIngredients: [
              "Alface",
              "Tomate",
              "Cebola caramelizada",
              "Molho",
              "Cheddar fatiado",
            ],
            simplesVegetables: ["Cebola caramelizada"],
            duploVegetables: ["Alface", "Tomate", "Cebola caramelizada"],
          },
          {
            nome: "3 Smash Simples",
            descricao:
              "3 unidades de smash simples, 100g cada! Carne prensada.",
            precoBase: [30],
            opcoes: ["Por apenas"],
            img: "./img/3sms.png",
            combo: true,
            burgers: ["1º Simples", "2º Simples", "3º Simples"],
            ingredients: [
              "Cebola caramelizada",
              "Cheddar fatiado",
              "Molho artesanal",
            ],
            vegetables: ["Cebola caramelizada"],
          },
          {
            nome: "Clone (2 Duplos)",
            descricao: "Acompanha dois deliciosos Smash Duplos, o mais pedido!",
            precoBase: [30],
            opcoes: ["Por apenas"],
            img: "./img/clone.png",
            combo: true,
            burgers: ["1º Duplo", "2º Duplo"],
            ingredients: [
              "Alface",
              "Tomate",
              "Cebola caramelizada",
              "Molho",
              "Cheddar fatiado",
            ],
            vegetables: ["Alface", "Tomate", "Cebola caramelizada"],
          },
          {
            nome: "1 Simples + 2 Duplos",
            descricao: "O combo acompanha um Smash Simples e dois Smash Duplos",
            precoBase: [40],
            opcoes: ["Por apenas"],
            img: "./img/simples2duplos.png",
            combo: true,
            burgers: ["Simples", "1º Duplo", "2º Duplo"],
            simplesIngredients: [
              "Cebola caramelizada",
              "Molho artesanal",
              "Cheddar fatiado",
            ],
            duploIngredients: [
              "Alface",
              "Tomate",
              "Cebola caramelizada",
              "Molho",
              "Cheddar fatiado",
            ],
            simplesVegetables: ["Cebola caramelizada"],
            duploVegetables: ["Alface", "Tomate", "Cebola caramelizada"],
          },
          {
            nome: "3 Duplos",
            descricao: "Três deliciosos Smash Duplos, aproveita e pede o teu!",
            precoBase: [45],
            opcoes: ["Por apenas"],
            img: "./img/3duplos.png",
            combo: true,
            burgers: ["1º Duplo", "2º Duplo", "3º Duplo"],
            ingredients: [
              "Alface",
              "Tomate",
              "Cebola caramelizada",
              "Molho",
              "Cheddar fatiado",
            ],
            vegetables: ["Alface", "Tomate", "Cebola caramelizada"],
            paidExtras: [
              { nome: "Bacon", preco: 4 },
              { nome: "Carne Smash", preco: 5 },
              { nome: "Ovo", preco: 2 },
              { nome: "Cream Cheese", preco: 3 },
            ],
          },
          {
            nome: "Combo Plus!",
            descricao:
              "Compõe 4 smash duplos, junto a Batata G com cheddar e bacon!.",
            precoBase: [75],
            opcoes: ["Por apenas"],
            img: "./img/comboplus.png",
            combo: true,
            burgers: ["1º Duplo", "2º Duplo", "3º Duplo", "4º Duplo"],
            ingredients: [
              "Alface",
              "Tomate",
              "Cebola caramelizada",
              "Molho",
              "Cheddar fatiado",
            ],
            vegetables: ["Alface", "Tomate", "Cebola caramelizada"],
            adicionais: [{ nome: "Batata leva bacon", preco: 0 }],
          },
        ],
        Artesanais: [
          {
            nome: "Smash",
            opcoes: ["Simples", "Duplo", "Triplo Bacon"],
            descricao: "Carne prensada na chapa, 100g cada suculência.",
            precoBase: [12, 18, 25],
            ingredientesPorOpcao: {
              Simples: [
                "Cebola caramelizada",
                "Cheddar fatiado",
                "Molho artesanal",
              ],
              Duplo: [
                "2x Carne Smash",
                "Cheddar",
                "Alface",
                "Tomate",
                "Molho artesanal",
              ],
              "Triplo Bacon": [
                "3x Carne Smash",
                "Cheddar",
                "Bacon",
                "Molho artesanal",
              ],
            },
            adicionais: [
              { nome: "Bacon", preco: 4 },
              { nome: "Carne", preco: 5 },
              { nome: "Cream Cheese", preco: 3 },
              { nome: "Ovo", preco: 2 },
            ],
            img: "./img/3sms.png",
          },
          {
            nome: "Cremoso",
            opcoes: ["Simples", "Duplo"],
            descricao:
              "Delicioso artesanal com cream cheese incluso, vai perder?",
            precoBase: [16, 25],
            ingredientesPadrao: [
              "Alface",
              "Tomate",
              "Molho artesanal",
              "Cheddar fatiado",
              "Cream cheese",
              "Cebola caramelizada",
            ],
            adicionais: [
              { nome: "Bacon", preco: 4 },
              { nome: "Carne", preco: 5 },
              { nome: "Cream Cheese", preco: 3 },
              { nome: "Ovo", preco: 2 },
            ],
            img: "./img/cc.png",
          },
          {
            nome: "Cheese",
            opcoes: ["Simples", "Duplo"],
            descricao: "Para os amantes de queijo: Cheddar em dobro!",
            precoBase: [14, 20],
            ingredientesPadrao: [
              "Alface",
              "Tomate",
              "Molho artesanal",
              "Dobro de Cheddar",
              "Cebola caramelizada",
            ],
            adicionais: [
              { nome: "Bacon", preco: 4 },
              { nome: "Carne", preco: 5 },
              { nome: "Cream Cheese", preco: 3 },
              { nome: "Ovo", preco: 2 },
            ],
            img: "./img/cheese.png",
          },
          {
            nome: "Eggy",
            opcoes: ["Simples", "Duplo"],
            descricao: "O clássico com ovo frito, delicioso!",
            precoBase: [15, 20],
            ingredientesPadrao: [
              "Alface",
              "Tomate",
              "Molho artesanal",
              "Ovo",
              "Cebola caramelizada",
            ],
            adicionais: [
              { nome: "Bacon", preco: 4 },
              { nome: "Carne", preco: 5 },
              { nome: "Cream Cheese", preco: 3 },
              { nome: "Ovo", preco: 2 },
            ],
            img: "./img/eggy.png",
          },
        ],
        "Costela Bovina": [
          {
            nome: "Costela Bovina - Premium",
            opcoes: ["Simples", "Duplo", "Triplo Bacon"],
            descricao:
              "Carne de costela bovina, suculência em 100g cada carne.",
            precoBase: [18, 25, 30],
            ingredientesPadrao: [
              "Alface",
              "Tomate",
              "Cebola Caramelizada",
              "Molho artesanal",
              "Cheddar fatiado",
            ],
            adicionais: [
              { nome: "Bacon", preco: 4 },
              { nome: "Carne", preco: 5 },
              { nome: "Cream Cheese", preco: 3 },
              { nome: "Ovo", preco: 2 },
            ],
            img: "./img/rtriplo.png",
          },
        ],
        "Batata Frita": [
          {
            nome: "Batata",
            opcoes: ["Pequena", "Média", "Grande"],
            precoBase: [8, 12, 16],
            img: "./img/batata.png",
            adicionais: [
              { nome: "Bacon", preco: 2 },
              { nome: "Cheddar", preco: 2 },
            ],
          },
        ],
        Bebidas: [
          {
            nome: "Coca Cola",
            opcoes: ["Lata", "Lata Zero", "Litro"],
            precoBase: [6, 6, 9],
            img: "./img/coca.png",
          },
          {
            nome: "Antártica",
            opcoes: ["Lata", "Litro"],
            precoBase: [5, 8],
            img: "./img/antartica.png",
          },
          {
            nome: "Cajá",
            opcoes: ["300ml"],
            precoBase: [5],
            descricao: "Suco de polpa de Cajá.",
            img: "./img/suco_polpa.png",
          },
          {
            nome: "Maracujá",
            opcoes: ["300ml"],
            precoBase: [5],
            descricao: "Suco de polpa de maracujá.",
            img: "./img/suco_polpa.png",
          },
          {
            nome: "Graviola",
            opcoes: ["300ml"],
            precoBase: [5],
            descricao: "Suco de polpa de Graviola.",
            img: "./img/suco_polpa.png",
          },
        ],
        "Milk Shakes": [
          {
            nome: "Morango",
            opcoes: ["300ml", "400ml"],
            precoBase: [10, 12],
            img: "./img/milks.png",
          },
          {
            nome: "Ninho",
            opcoes: ["300ml", "400ml"],
            precoBase: [10, 12],
            img: "./img/milks.png",
          },
          {
            nome: "Ninho Oreo",
            opcoes: ["300ml", "400ml"],
            precoBase: [12, 14],
            img: "./img/milks.png",
          },
          {
            nome: "Delicia de Abacaxi",
            opcoes: ["300ml", "400ml"],
            precoBase: [10, 12],
            img: "./img/milks.png",
          },
          {
            nome: "Paçoca",
            opcoes: ["300ml", "400ml"],
            precoBase: [10, 12],
            img: "./img/milks.png",
          },
          {
            nome: "Ovomaltine",
            opcoes: ["300ml", "400ml"],
            precoBase: [12, 14],
            img: "./img/milks.png",
          },
        ],
      };

      /**
       * Helper: Mapeia um ID de cartão (pode ser o ID original do pedido ou o ID agregado "Mesa X" / "Nome Cliente")
       * para todos os IDs originais de pedidos parciais PENDENTES no localStorage que o compõem.
       */
      function getPedidosByAggregatedId(id, pedidos) {
        // Se for um ID numérico (de um pedido concluído/cancelado isolado), retorna apenas ele.
        if (id.startsWith("p") && !id.includes("Mesa") && !isNaN(id.substring(1))) return [id];

        const idsToUpdate = [];
        const mesaKey = id;

        pedidos.forEach((p) => {
          // Verifica se a opção de atendimento inclui a chave da mesa/nome OU o nomeCliente é a chave
          if (
            ((p.opcaoAtendimento && p.opcaoAtendimento.includes(mesaKey)) ||
              p.nomeCliente === mesaKey) &&
            p.status !== "concluido" &&
            p.status !== "cancelado"
          ) {
            idsToUpdate.push(p.id);
          }
        });
        return idsToUpdate;
      }

      /**
       * Alterna a classe 'collapsed' para esconder/mostrar o conteúdo do cartão.
       */
      function toggleCollapse(headerElement) {
        const card = headerElement.closest(".card");
        card.classList.toggle("collapsed");
      }

      /**
       * Helper: Renderiza um único cartão de pedido com os novos estilos.
       */
      function renderCard(pedido, containerDiv, isAgregado = false) {
        const status = pedido.status || "pendente";
        const itens = isAgregado ? pedido.itensAgregados : pedido.itens;
        const total = isAgregado
          ? pedido.totalAgregado.toFixed(2)
          : Number(pedido.total).toFixed(2);

        const nomeCliente = pedido.nomeCliente || "Sem nome";
        const codigoPedido = pedido.codigoPedido || "Sem código";
        const opcaoAtendimento = pedido.opcaoAtendimento || "Não especificado";
        const modalidadeConsumo = pedido.modalidadeConsumo || "Não Informado";

        const statusClassMap = {
          pendente: "status-pendente",
          aceito: "status-aceito",
          pronto: "status-concluido",
          concluido: "status-concluido",
          cancelado: "status-cancelado",
        };

        // Lógica de distinção do tipo de pedido
        const tipoPedido =
          pedido.tipo ||
          (pedido.opcaoAtendimento && pedido.opcaoAtendimento.includes("Mesa")
            ? "Mesa"
            : "Autoatendimento");
        const tipoBadge = tipoPedido === "Mesa" ? "MESA" : "MONITOR";
        const tipoClass =
          tipoPedido === "Mesa" ? "tipo-mesa" : "tipo-autoatendimento";

        let pagamentosStr = "Não especificado";
        if (
          !isAgregado &&
          pedido.pagamentos &&
          Array.isArray(pedido.pagamentos) &&
          pedido.pagamentos.length > 0
        ) {
          pagamentosStr = pedido.pagamentos
            .map((p) => {
              let str = `<div>${p.method}: R$ ${Number(p.value).toFixed(2)}`;
              if (p.method === "Dinheiro" && p.troco && p.troco > 0) {
                str += ` <span class="pagamento-troco">(Troco: R$ ${Number(
                  p.troco
                ).toFixed(2)})</span>`;
              }
              str += `</div>`;
              return str;
            })
            .join("");
        }

        const card = document.createElement("div");
        const isCollapsed = status === "concluido" || status === "cancelado";

        card.className = "card " + (isCollapsed ? `collapsed ${status}` : "");

        const cardActionId = isAgregado ? pedido.id : pedido.id;

        card.innerHTML = `
          <div class="card-header" ${
            isCollapsed ? `onclick="toggleCollapse(this)"` : ""
          }>
            <h3>${
              isAgregado ? pedido.opcaoAtendimento : `Comanda: ${nomeCliente}`
            } (Código: ${codigoPedido})</h3>
            <div style="display:flex; align-items:center;">
                <span class="tipo-badge ${tipoClass}">${tipoBadge}</span>
                <span class="${
                  statusClassMap[status] || statusClassMap["pendente"]
                }">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                ${isCollapsed ? '<span class="toggle-icon">&gt;</span>' : ""}
            </div>
          </div>
          <div class="card-content">
            <p><strong>Modalidade:</strong> ${modalidadeConsumo}</p>
            <p><strong>Itens:</strong> <span class="itens">${itens.join(
              "<br>"
            )}</span></p>
            <p><strong>Total:</strong> R$ ${total}</p>
            ${
              !isAgregado && pedido.pagamentos
                ? `
                <p><strong>Pagamento:</strong></p>
                ${pagamentosStr}
            `
                : ""
            }
            ${
              pedido.ingredientesAdicionais
                ? `<p><strong>Observação/Adicionais:</strong> ${pedido.ingredientesAdicionais}</p>`
                : ""
            }
            <p><strong>Opção:</strong> ${opcaoAtendimento}</p>
          </div>
          ${
            !isCollapsed
              ? `
            <div class="card-actions">
              <button class="btn-aceitar" onclick="atualizarStatus('${cardActionId}', 'aceito')">Aceitar</button>
              <button class="btn-cancelar" onclick="atualizarStatus('${cardActionId}', 'cancelar')">Cancelar</button>
              <button class="btn-adicionar" onclick="abrirModal('${cardActionId}')">Anotar Observação</button>
              <button class="btn-adicionar" onclick="abrirModalAdicionarItem('${cardActionId}')">Add Item</button>
              <button class="btn-pronto" onclick="atualizarStatus('${cardActionId}', 'concluido')">Marcar Pronto</button>
              <button class="btn-imprimir" onclick="imprimirPedido('${cardActionId}')">Comandas</button> <button class="btn-excluir" onclick="excluirPedido('${cardActionId}')">Excluir</button>
            </div>
          `
              : `
            <div class="card-actions">
              <button class="btn-excluir" onclick="excluirPedido('${cardActionId}')">Excluir</button>
              <button class="btn-imprimir" onclick="imprimirPedido('${cardActionId}')">Imprimir</button> </div>
          `
          }
        `;
        containerDiv.appendChild(card);
      }

      function carregarPedidos() {
        const pedidosRaw = JSON.parse(localStorage.getItem("pedidos") || "[]");
        const pendentesDiv = document.getElementById("pendentes");
        const concluidosDiv = document.getElementById("concluidos");
        pendentesDiv.innerHTML = "";
        concluidosDiv.innerHTML = "";

        const pedidosPendentesAgregados = {};

        pedidosRaw.forEach((pedido) => {
          const status = pedido.status || "pendente";

          if (status === "concluido" || status === "cancelado") {
            // Pedidos concluídos/cancelados: Renderiza diretamente
            const tipoPedido =
              pedido.tipo ||
              (pedido.opcaoAtendimento &&
              pedido.opcaoAtendimento.includes("Mesa")
                ? "Mesa"
                : "Autoatendimento");
            pedido.tipo = tipoPedido;
            renderCard(pedido, concluidosDiv);
          } else {
            // Pedidos pendentes/aceitos: Agrega por mesa/cliente
            const opcaoAtendimento =
              pedido.opcaoAtendimento || "Não especificado";
            const mesaMatch = opcaoAtendimento.match(/Mesa (\d+)/);
            // Determina a chave e o tipo
            const mesaKey = mesaMatch
              ? `Mesa ${mesaMatch[1]}`
              : pedido.nomeCliente || "Diversos Pendentes";
            const tipoPedido = mesaMatch ? "Mesa" : "Autoatendimento";

            if (!pedidosPendentesAgregados[mesaKey]) {
              pedidosPendentesAgregados[mesaKey] = {
                id: mesaKey,
                nomeCliente: pedido.nomeCliente || mesaKey,
                codigoPedido: pedido.codigoPedido || "Sem código",
                opcaoAtendimento: mesaKey,
                status: status,
                // ADICIONA O TIPO AQUI
                tipo: tipoPedido,
                modalidadeConsumo: pedido.modalidadeConsumo || "Não Informado", // NOVO CAMPO
                ingredientesAdicionais: pedido.ingredientesAdicionais || "",
                idsOriginais: [pedido.id],
                itensAgregados: [...pedido.itens],
                totalAgregado: Number(pedido.total || 0),
                pagamentos: null,
              };
              if (status === "aceito")
                pedidosPendentesAgregados[mesaKey].status = "aceito";
            } else {
              // Agregação de dados
              pedidosPendentesAgregados[mesaKey].idsOriginais.push(pedido.id);
              pedidosPendentesAgregados[mesaKey].itensAgregados.push(
                ...pedido.itens
              );
              pedidosPendentesAgregados[mesaKey].totalAgregado += Number(
                pedido.total || 0
              );
              if (status === "aceito")
                pedidosPendentesAgregados[mesaKey].status = "aceito";

              if (pedido.ingredientesAdicionais) {
                const existing =
                  pedidosPendentesAgregados[mesaKey].ingredientesAdicionais;
                pedidosPendentesAgregados[mesaKey].ingredientesAdicionais =
                  existing
                    ? `${existing}; ${pedido.ingredientesAdicionais}`
                    : pedido.ingredientesAdicionais;
              }
            }
          }
        });

        Object.values(pedidosPendentesAgregados).forEach((pedidoAgregado) => {
          renderCard(pedidoAgregado, pendentesDiv, true);
        });

        if (Object.keys(pedidosPendentesAgregados).length === 0) {
          pendentesDiv.innerHTML = "<p>Nenhum pedido pendente.</p>";
        }
        if (concluidosDiv.innerHTML === "") {
          concluidosDiv.innerHTML =
            "<p>Nenhum pedido concluído ou cancelado.</p>";
        }
      }

      function atualizarStatus(id, novoStatus) {
        const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
        const idsToUpdate = getPedidosByAggregatedId(id, pedidos);

        let updated = false;
        idsToUpdate.forEach((rawId) => {
          const index = pedidos.findIndex((p) => p.id === rawId);
          if (index !== -1) {
            pedidos[index].status = novoStatus;
            updated = true;
          }
        });

        if (updated) {
          localStorage.setItem("pedidos", JSON.stringify(pedidos));
          carregarPedidos();
          showNotification(`Comanda ${id} marcada como ${novoStatus}.`);
        }
      }

      function excluirPedido(id) {
        if (!confirm("Tem certeza que deseja excluir o pedido/comanda?"))
          return;
        const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
        const idsToExclude = getPedidosByAggregatedId(id, pedidos);

        const novosPedidos = pedidos.filter(
          (p) => !idsToExclude.includes(p.id)
        );

        if (novosPedidos.length !== pedidos.length) {
          localStorage.setItem("pedidos", JSON.stringify(novosPedidos));
          carregarPedidos();
          showNotification(`Comanda ${id} excluída com sucesso.`);
        }
      }

      // --- FUNÇÃO DE IMPRESSÃO (NOVA) ---

      /**
       * Gera e dispara a impressão de um pedido/comanda agregada, formatando como um recibo.
       * @param {string} aggregatedId - O ID agregado (Ex: "Mesa 5" ou "Nome Cliente") ou ID pXXX de pedido único.
       */
      function imprimirPedido(aggregatedId) {
          const pedidosRaw = JSON.parse(localStorage.getItem("pedidos") || "[]");
          
          // 1. Encontra os IDs originais que compõem a comanda (incluindo concluídos/cancelados)
          const idsOriginais = [];
          // Se for um ID de pedido único (Ex: p123456789)
          if (aggregatedId.startsWith('p') && !aggregatedId.includes("Mesa") && !isNaN(aggregatedId.substring(1))) {
              idsOriginais.push(aggregatedId);
          } else {
              // Se for um ID agregado (Mesa X, Nome Cliente), busca todos os relacionados
              pedidosRaw.forEach(p => {
                  if (((p.opcaoAtendimento && p.opcaoAtendimento.includes(aggregatedId)) || p.nomeCliente === aggregatedId)) {
                      idsOriginais.push(p.id);
                  }
              });
          }

          if (idsOriginais.length === 0) {
              showNotification("Erro: Comanda não encontrada para impressão.", 3000, "error");
              return;
          }

          // 2. Agregação de Dados para Impressão
          let itensAgregados = [];
          let totalAgregado = 0;
          let observacoes = [];
          let pagamentosUnicos = {}; 
          let modalidadeConsumo = "";

          const pedidosParaImpressao = pedidosRaw.filter(p => idsOriginais.includes(p.id));
          
          const pedidoReferencia = pedidosParaImpressao[0];
          if (!pedidoReferencia) return;

          // Cabeçalho da impressão
          const nomeComanda = aggregatedId; // Usar o ID agregado como nome principal
          const codigoPedido = pedidoReferencia.codigoPedido || "S/Cód";
          const opcaoAtendimento = pedidoReferencia.opcaoAtendimento || "Manual";
          const tipoOrigem = pedidoReferencia.tipo || (opcaoAtendimento.includes("Mesa") ? "Mesa" : "Monitor");
          modalidadeConsumo = pedidoReferencia.modalidadeConsumo || "Não Informado";

          pedidosParaImpressao.forEach(p => {
              // Agrega itens
              itensAgregados.push(...p.itens);
              totalAgregado += Number(p.total || 0);

              // Agrega observações
              if (p.ingredientesAdicionais) {
                  observacoes.push(p.ingredientesAdicionais);
              }

              // Soma pagamentos
              if (p.pagamentos && p.pagamentos.length > 0) {
                  p.pagamentos.forEach(pag => {
                      const method = pag.method || "Desconhecido";
                      const value = Number(pag.value || 0);
                      pagamentosUnicos[method] = (pagamentosUnicos[method] || 0) + value;
                  });
              }
          });
          
          // Formatação dos Itens (Contagem de quantidades)
          const itemMap = {};
          itensAgregados.forEach(item => {
              itemMap[item] = (itemMap[item] || 0) + 1;
          });

          let itensHtml = "";
          for (const item in itemMap) {
              // Formato: 2x Item (com personalização)
              itensHtml += `<div class="print-item"><span class="quantity">${itemMap[item]}x</span> <span>${item}</span></div>`;
          }

          // Formatação dos Pagamentos
          let pagamentosHtml = "";
          const pagamentosArray = Object.keys(pagamentosUnicos).map(method => 
              `<p style="margin-bottom: 0;">${method}: R$ ${pagamentosUnicos[method].toFixed(2)}</p>`
          );
          if (pagamentosArray.length > 0) {
              pagamentosHtml = `<p>VALOR RECEBIDO:</p>${pagamentosArray.join("")}`;
              // Procura por troco em qualquer pagamento em dinheiro
              const pagamentoDinheiro = pedidosParaImpressao.flatMap(p => p.pagamentos || []).find(p => p.method === "Dinheiro");
              if (pagamentoDinheiro && pagamentoDinheiro.troco && pagamentoDinheiro.troco > 0) {
                   pagamentosHtml += `<p style="color: red; font-weight: bold;">TROCO: R$ ${Number(pagamentoDinheiro.troco).toFixed(2)}</p>`;
              }
          } else {
              pagamentosHtml = `<p>A Pagar: R$ ${totalAgregado.toFixed(2)}</p>`;
          }


          // 3. Criação do HTML para Impressão
          const printContent = `
              <div class="print-area">
                  <div class="print-header">
                      <h1>Ribbs</h1>
                      <p style="text-align: center; font-size: 0.9em;">(Comanda ${tipoOrigem})</p>
                      <p style="text-align: center; font-size: 0.9em; font-weight: bold;">${modalidadeConsumo.toUpperCase()}</p>
                  </div>
                  <div class="print-separator"></div>
                  <div class="print-info">
                      <p><strong>CLIENTE:</strong> ${nomeComanda}</p>
                      <p><strong>CÓD:</strong> ${codigoPedido}</p>
                      <p><strong>DATA/HORA:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                  </div>
                  <div class="print-separator"></div>
                  <h3>ITENS DO PEDIDO:</h3>
                  <div class="print-items">
                      ${itensHtml}
                  </div>
                  ${observacoes.length > 0 ? `<div class="print-separator"></div><p style="font-weight: bold;">OBSERVAÇÕES GERAIS:</p><p>${observacoes.join("; ")}</p>` : ''}
                  <div class="print-separator"></div>
                  <div class="print-total">
                      TOTAL GERAL: R$ ${totalAgregado.toFixed(2)}
                  </div>
                  <div class="print-separator"></div>
                  <div class="print-payment">
                      <strong>FORMA DE PAGAMENTO:</strong>
                      ${pagamentosHtml}
                  </div>
                  <div class="print-separator"></div>
                  <p style="text-align: center; font-size: 0.8em; margin-top: 10px;">Obrigado pela preferência!</p>
              </div>
          `;

          // 4. Disparar Impressão usando a DOM
          
          const printDivId = 'print-output-container';
          let printContainer = document.getElementById(printDivId);
          
          printContainer.innerHTML = printContent;

          // Dispara a impressão (o CSS @media print garante que apenas este bloco seja impresso)
          window.print();
          
          // Limpeza (Remove o conteúdo de impressão após o print/cancelar)
          setTimeout(() => {
              printContainer.innerHTML = '';
          }, 500); 

      }

      // --- FUNÇÕES DE MODAL GENÉRICAS ---

      function fecharModal(id) {
        document.getElementById(id).style.display = "none";
        // Limpeza específica para o modal de adicionar item
        if (id === "modal-adicionar-item") {
          activeMesaId = null; // Zera o ID da mesa ativa
          closePopupCustom(false); // Garante que o popup de personalização esteja fechado, mas não reabre o modal principal
        }
        if (id === "modal-adicionar") {
          document.getElementById("ingredientes-input").value = "";
          pedidoSelecionadoId = null;
        }
      }

      function abrirModal(id) {
        pedidoSelecionadoId = id; // ID agregado (Mesa X ou Nome Cliente)
        document.getElementById("modal-adicionar").style.display = "flex";
        document.getElementById("ingredientes-input").focus();
      }

      function salvarIngredientes() {
        const ingredientes = document
          .getElementById("ingredientes-input")
          .value.trim();
        if (ingredientes) {
          const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");

          const idsToUpdate = getPedidosByAggregatedId(
            pedidoSelecionadoId,
            pedidos
          );

          // Encontra o PRIMEIRO pedido PENDENTE da comanda
          const index = pedidos.findIndex(
            (p) =>
              idsToUpdate.includes(p.id) &&
              p.status !== "concluido" &&
              p.status !== "cancelado"
          );

          if (index !== -1) {
            pedidos[index].ingredientesAdicionais = ingredientes;
            localStorage.setItem("pedidos", JSON.stringify(pedidos));
            carregarPedidos();
            fecharModal("modal-adicionar");
            showNotification(
              `Observação adicionada à comanda ${pedidoSelecionadoId}.`
            );
          } else {
            // Caso não encontre um pedido em aberto, aplica ao primeiro ID encontrado
            const singleIndex = pedidos.findIndex(
              (p) => p.id === idsToUpdate[0]
            );
            if (singleIndex !== -1) {
              pedidos[singleIndex].ingredientesAdicionais = ingredientes;
              localStorage.setItem("pedidos", JSON.stringify(pedidos));
              carregarPedidos();
              fecharModal("modal-adicionar");
              showNotification(
                `Observação adicionada à comanda ${pedidoSelecionadoId}.`
              );
            }
          }
        }
      }

      // --- FUNÇÕES DE ADICIONAR ITEM (CARDÁPIO) ---

      function hasCustomization(item) {
        return (
          (item.adicionais && item.adicionais.length > 0) ||
          item.ingredientesPorOpcao ||
          item.ingredientesPadrao || // Adicionado para Cremoso/Cheese/Eggy
          item.combo
        );
      }

      function abrirModalAdicionarItem(mesaId) {
        activeMesaId = mesaId; // ID agregado (Ex: "Mesa 1" ou "ribbszn")
        renderCategories();
        document.getElementById("modal-adicionar-item").style.display = "flex";
      }

      function renderCategories() {
        const topoDiv = document.getElementById("cozinha-sessao-topo");
        topoDiv.innerHTML = "";
        const categories = Object.keys(cardapioData);
        categories.forEach((cat) => {
          const btn = document.createElement("button");
          btn.textContent = cat;
          btn.onclick = () => showCategoryCozinha(cat, btn);
          topoDiv.appendChild(btn);
        });
        if (categories.length > 0) {
          const firstButton = topoDiv.querySelector("button");
          if (firstButton) {
            showCategoryCozinha(categories[0], firstButton);
            firstButton.classList.add("active");
          }
        }
      }

      function showCategoryCozinha(cat, btn) {
        document
          .querySelectorAll("#cozinha-sessao-topo button")
          .forEach((b) => b.classList.remove("active"));
        if (btn) btn.classList.add("active");

        const cardapioDiv = document.getElementById("cozinha-cardapio");
        cardapioDiv.innerHTML = "";

        (cardapioData[cat] || []).forEach((item, i) => {
          const opts = item.opcoes || [""];
          opts.forEach((op, j) => {
            const price =
              item.precoBase[j] !== undefined
                ? item.precoBase[j]
                : item.precoBase[0] || 0;
            const card = document.createElement("div");
            card.className = "cozinha-card";

            card.innerHTML = `
                    <div class="cozinha-card-info">
                      <h4>${item.nome} ${op ? `(${op})` : ""}</h4>
                      <p class="price">R$ ${Number(price).toFixed(2)}</p>
                    </div>
                  `;
            const actionBtn = document.createElement("button");

            const isCustomizable = hasCustomization(item);
            actionBtn.textContent = isCustomizable
              ? "Personalizar"
              : "Adicionar";

            actionBtn.onclick = () => {
              if (isCustomizable) {
                openPopupCustomCozinha(cat, i, j);
              } else {
                adicionarDiretoCozinha(item.nome + (op ? " " + op : ""), price);
              }
            };
            card.appendChild(actionBtn);
            cardapioDiv.appendChild(card);
          });
        });
      }

      /**
       * Função principal para adicionar o item ao PRIMEIRO pedido em aberto da comanda agregada.
       */
      function adicionarDiretoCozinha(nome, preco) {
        const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");

        // CRÍTICO: Usa o helper para encontrar todos os IDs brutos da comanda
        const idsToUpdate = getPedidosByAggregatedId(activeMesaId, pedidos);

        // Encontra o índice do PRIMEIRO pedido pendente/aceito
        const index = pedidos.findIndex(
          (p) =>
            idsToUpdate.includes(p.id) &&
            p.status !== "concluido" &&
            p.status !== "cancelado"
        );

        if (index !== -1) {
          const pedido = pedidos[index];
          pedido.itens.push(nome.trim());
          pedido.total = (Number(pedido.total) + Number(preco)).toFixed(2);
          localStorage.setItem("pedidos", JSON.stringify(pedidos));
          carregarPedidos();
          showNotification(
            `Item '${nome}' adicionado à comanda ${activeMesaId}.`
          );
        } else {
          alert(
            "Erro: Comanda não encontrada ou status não permite adição. Verifique se a comanda está em aberto."
          );
        }

        fecharModal("modal-adicionar-item");
      }

      // Funções de Popup Personalização (Simplificadas)
      function openPopupCustomCozinha(cat, i, j) {
        const item = cardapioData[cat][i];
        currentItem = {
          cat,
          i,
          op: j,
          extras: [],
          precoBase: Number(item.precoBase[j] || item.precoBase[0] || 0),
        };
        const popup = document.getElementById("popupCustom");
        const q = document.getElementById("popupQuestion");
        q.innerHTML = "";

        document.getElementById("popupCustomTitle").textContent =
          item.nome +
          (item.opcoes && item.opcoes[j] ? ` (${item.opcoes[j]})` : "");

        // --- NOVO: Lógica para Ingredientes Padrão (Remoção) ---
        let defaultIngredients = [];
        const optionName = item.opcoes && item.opcoes[j] ? item.opcoes[j] : "";
        if (item.ingredientesPorOpcao) {
          defaultIngredients = item.ingredientesPorOpcao[optionName] || [];
        } else if (item.ingredientesPadrao) {
          defaultIngredients = item.ingredientesPadrao;
        }

        q.innerHTML += `<h4>Ingredientes Padrão (Desmarque para Remover):</h4>`;
        if (defaultIngredients.length > 0) {
          defaultIngredients.forEach((ing) => {
            // Checkboxes checados por padrão, para indicar que o ingrediente está incluso
            q.innerHTML += `<label style="display:block; color: var(--preto); margin-bottom: 5px;"><input type='checkbox' checked data-type='ingrediente' value='${ing}' style="width: auto; margin-right: 5px;"> ${ing}</label>`;
          });
        } else {
          q.innerHTML += `<p style="color: var(--preto);">Nenhum ingrediente base listado para remoção.</p>`;
        }

        // --- NOVO: Lógica para Adicionais Pagos (Adição) ---
        q.innerHTML += `<h4 style="margin-top: 20px;">Adicionais Pagos (Marque para Adicionar):</h4>`;
        if (item.adicionais && item.adicionais.length > 0) {
          item.adicionais.forEach((a) => {
            // Checkboxes desmarcados por padrão, para indicar que são extras
            q.innerHTML += `<label style="display:block; color: var(--preto); margin-bottom: 5px;"><input type='checkbox' data-type='adicional' data-preco='${
              a.preco
            }' value='${a.nome}' style="width: auto; margin-right: 5px;"> ${
              a.nome
            } (+R$ ${a.preco.toFixed(2)})</label>`;
          });
        } else {
          q.innerHTML += `<p style="color: var(--preto);">Nenhum adicional pago.</p>`;
        }

        document.getElementById("modal-adicionar-item").style.display = "none";
        popup.style.display = "flex";
      }

      function closePopupCustom(reopenParent = true) {
        document.getElementById("popupCustom").style.display = "none";
        if (reopenParent) {
          // Reabre o modal de adicionar item se não estiver vindo de um fecharModal('modal-adicionar-item')
          document.getElementById("modal-adicionar-item").style.display =
            "flex";
        }
      }

      function confirmPopupCustom() {
        const item = cardapioData[currentItem.cat][currentItem.i];
        let preco = Number(currentItem.precoBase);
        let nomeFinal = "";
        const opcao =
          item.opcoes && item.opcoes[currentItem.op]
            ? item.opcoes[currentItem.op]
            : "";

        let extras = []; // Adicionais Pagos
        let remocoes = []; // Ingredientes Padrão Removidos

        const checks = document.querySelectorAll(
          '#popupQuestion input[type="checkbox"]'
        );
        checks.forEach((c) => {
          if (c.dataset.type === "adicional") {
            if (c.checked) {
              if (c.dataset.preco) preco += Number(c.dataset.preco);
              extras.push(c.value); // Adicionais pagos
            }
          } else if (c.dataset.type === "ingrediente") {
            if (!c.checked) {
              remocoes.push(c.value); // Ingredientes padrão desmarcados (removidos)
            }
          }
        });

        nomeFinal = item.nome + (opcao ? ` ${opcao}` : "");

        // Adiciona as remoções ao nome final
        if (remocoes.length > 0) {
          nomeFinal += ` (SEM ${remocoes.join(", ")})`;
        }

        // Adiciona os extras pagos ao nome final
        if (extras.length > 0) {
          nomeFinal += ` + ${extras.join(", ")}`;
        }

        const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");

        // CRÍTICO: Usa o helper para encontrar todos os IDs brutos da comanda
        const idsToUpdate = getPedidosByAggregatedId(activeMesaId, pedidos);

        // Encontra o índice do PRIMEIRO pedido pendente/aceito
        const index = pedidos.findIndex(
          (p) =>
            idsToUpdate.includes(p.id) &&
            p.status !== "concluido" &&
            p.status !== "cancelado"
        );

        if (index !== -1) {
          const pedido = pedidos[index];
          pedido.itens.push(nomeFinal);
          pedido.total = (Number(pedido.total) + preco).toFixed(2);
          localStorage.setItem("pedidos", JSON.stringify(pedidos));
          carregarPedidos();
          showNotification(
            `Item '${nomeFinal}' adicionado à comanda ${activeMesaId}.`
          );
        } else {
          alert(
            "Erro: Comanda não encontrada ou status não permite adição. Verifique se a comanda está em aberto."
          );
        }

        // Fecha o popup de personalização e em seguida fecha o modal principal
        closePopupCustom(false); // Fecha o popup sem reabrir o modal pai
        fecharModal("modal-adicionar-item");
      }

      // --- FUNÇÃO DE NOTIFICAÇÃO ---

      function showNotification(message, duration = 3000, type = "success") {
        const notification = document.getElementById("custom-notification");
        const msgElement = document.getElementById("notification-message");

        msgElement.textContent = message;

        // Limpa estilos antigos e aplica novos
        notification.style.backgroundColor =
          type === "success" ? "var(--accent-verde)" : "var(--accent-vermelho)";
        notification.classList.add("show");
        notification.style.display = "block";

        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            notification.style.display = "none";
          }, 500); // tempo de transição
        }, duration);
      }

      // --- TEMA CLARO/ESCURO ---

      const themeToggle = document.getElementById("theme-toggle");
      const body = document.body;
      const DARK_MODE_CLASS = "dark-mode";
      const STORAGE_KEY = "ribbsProTheme";

      function applyTheme(theme) {
        if (theme === "dark") {
          body.classList.add(DARK_MODE_CLASS);
          themeToggle.textContent = "Modo Claro";
          localStorage.setItem(STORAGE_KEY, "dark");
        } else {
          body.classList.remove(DARK_MODE_CLASS);
          themeToggle.textContent = "Modo Escuro";
          localStorage.setItem(STORAGE_KEY, "light");
        }
      }

      // 1. Carregar o tema salvo
      const savedTheme = localStorage.getItem(STORAGE_KEY);
      if (savedTheme) {
        applyTheme(savedTheme);
      } else {
        // Opcional: Verificar preferência do sistema operacional
        if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          applyTheme("dark");
        } else {
          applyTheme("light");
        }
      }

      // 2. Adicionar listener para o botão
      themeToggle.addEventListener("click", () => {
        const currentTheme = body.classList.contains(DARK_MODE_CLASS)
          ? "dark"
          : "light";
        const newTheme = currentTheme === "light" ? "dark" : "light";
        applyTheme(newTheme);
      });
      // --- FIM TEMA CLARO/ESCURO ---

      // --- INICIALIZAÇÃO ---
      carregarPedidos();

      // Reduzindo o intervalo de refresh para 3000ms para maior performance
      setInterval(carregarPedidos, 3000);

      window.addEventListener("storage", carregarPedidos);

      /*
        FUNÇÃO ADICIONADA:
        cria nova comanda no localStorage com o mesmo formato dos pedidos existentes
        e abre o modal de adicionar item usando a função já existente.
      */
      
      // NOVO: Função para confirmar e criar o novo pedido usando o modal
      function confirmarNovoPedido() {
        const nome = document.getElementById("nome-comanda-input").value.trim();
        if (!nome) {
            showNotification("O nome da comanda não pode estar vazio.", 3000, "error");
            document.getElementById("nome-comanda-input").focus();
            return;
        }

        const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");

        const idUnico = "p" + Date.now();
        const idParaAgregacao = nome; // Chave que será usada pelo carregarPedidos/abrirModalAdicionarItem

        const novoPedido = {
            id: idUnico,
            codigoPedido: Math.floor(1000 + Math.random() * 9000),
            nomeCliente: nome,
            opcaoAtendimento: `Comanda: ${nome}`,
            modalidadeConsumo: "Não Informado", // Definir a modalidade se necessário
            status: "pendente",
            itens: [],
            total: 0,
            pagamentos: [],
            tipo: "Manual"
        };

        pedidos.push(novoPedido);
        localStorage.setItem("pedidos", JSON.stringify(pedidos));

        // 1. Fecha o modal de nome
        fecharModal("modal-novo-pedido-nome");

        // 2. Recarrega a lista para mostrar o novo card
        carregarPedidos();

        // 3. Notifica
        showNotification(`Comanda '${nome}' criada com sucesso.`);

        // 4. Abre o modal para adicionar itens.
        abrirModalAdicionarItem(idParaAgregacao);
      }
      
      // FUNÇÃO ORIGINAL MODIFICADA: Apenas abre o modal de nome
      function adicionarNovoPedido() {
          // Limpa o campo de input e abre o modal personalizado
          document.getElementById("nome-comanda-input").value = "";
          document.getElementById("modal-novo-pedido-nome").style.display = "flex";
          document.getElementById("nome-comanda-input").focus();
      }
    </script>
  </body>
</html>